import os
import uuid
import wave
import pyaudio
from gtts import gTTS
from google.cloud import storage
import pygame
import re

# â€”â€”â€”â€”â€” í™˜ê²½ ì„¤ì • â€”â€”â€”â€”â€”   
# íŒŒì¼ ìœ„ì¹˜ ìˆ˜ì • í•„ìš”
os.environ["GOOGLE_APPLICATION_CREDENTIALS"] = "turnkey-channel-454904-b0-33a5c7635740.json"
BUCKET_NAME = "a_sample"

# ë…¹ìŒ ì„¤ì •
CHUNK = 1024
FORMAT = pyaudio.paInt16
CHANNELS = 1
RATE = 16000
RECORD_SECONDS = 10

# â€”â€”â€”â€”â€” íŒŒì¼ëª… ì•ˆì „ ì²˜ë¦¬ í•¨ìˆ˜ â€”â€”â€”â€”â€”
def sanitize(text: str) -> str:
    """íŒŒì¼ëª…ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ë³€í™˜ (<> ì œì™¸)"""
    text = text.strip()
    # í—ˆìš©ë˜ì§€ ì•ŠëŠ” ë¬¸ì: \ / * ? : " < > | 
    text = re.sub(r'[\\/*?:"<>|]', "_", text)
    return text or "untitled"

# â€”â€”â€”â€”â€” GCS ì—…ë¡œë“œ í•¨ìˆ˜ â€”â€”â€”â€”â€”
def upload_to_gcs(local_path: str, blob_name: str):
    client = storage.Client()
    bucket = client.bucket(BUCKET_NAME)
    blob = bucket.blob(blob_name)
    blob.upload_from_filename(local_path)
    print(f"âœ… GCS ì—…ë¡œë“œ: gs://{BUCKET_NAME}/{blob_name}")

# â€”â€”â€”â€”â€” TTS ìƒì„±Â·ì¬ìƒÂ·ì—…ë¡œë“œ â€”â€”â€”â€”â€”
def tts_and_play(text: str, safe: str):
    # TTS íŒŒì¼ëª…
    tts_filename = f"EX_{safe}.mp3"
    local_tts = os.path.join(os.path.expanduser("~"), tts_filename)
    # 1) TTS ë³€í™˜
    tts = gTTS(text=text, lang='ko')
    tts.save(local_tts)
    print(f"ğŸ”Š TTS ì €ì¥: {local_tts}")

    # 2) GCS ì—…ë¡œë“œ
    upload_to_gcs(local_tts, tts_filename)

    # 3) ìŠ¤í”¼ì»¤ ì¬ìƒ
    pygame.mixer.init()
    pygame.mixer.music.load(local_tts)
    pygame.mixer.music.play()
    while pygame.mixer.music.get_busy():
        pass
    pygame.mixer.quit()
    print("ğŸ”ˆ ì¬ìƒ ì™„ë£Œ")

# â€”â€”â€”â€”â€” ë…¹ìŒÂ·ì €ì¥Â·ì—…ë¡œë“œ â€”â€”â€”â€”â€”
def record_and_upload(safe: str):
    rec_filename = f"{safe}.wav"
    local_rec = os.path.join(os.path.expanduser("~"), rec_filename)
    p = pyaudio.PyAudio()
    stream = p.open(format=FORMAT,
                    channels=CHANNELS,
                    rate=RATE,
                    input=True,
                    frames_per_buffer=CHUNK)
    print(f"ğŸ™ï¸ {RECORD_SECONDS}ì´ˆê°„ ë…¹ìŒ ì‹œì‘...")
    frames = [stream.read(CHUNK) for _ in range(int(RATE/CHUNK*RECORD_SECONDS))]
    print("â¹ ë…¹ìŒ ì™„ë£Œ")

    stream.stop_stream()
    stream.close()
    p.terminate()

    # WAVë¡œ ì €ì¥
    with wave.open(local_rec, 'wb') as wf:
        wf.setnchannels(CHANNELS)
        wf.setsampwidth(p.get_sample_size(FORMAT))
        wf.setframerate(RATE)
        wf.writeframes(b''.join(frames))
    print(f"ğŸ’¾ ë…¹ìŒ íŒŒì¼ ì €ì¥: {local_rec}")

    # GCS ì—…ë¡œë“œ
    upload_to_gcs(local_rec, rec_filename)

# â€”â€”â€”â€”â€” ë©”ì¸ â€”â€”â€”â€”â€”
if __name__ == "__main__":
    try:
        raw_text = input("â–¶ TTSë¡œ ë³€í™˜í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”: ").strip()
        if not raw_text:
            print("â— í…ìŠ¤íŠ¸ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. ì¢…ë£Œí•©ë‹ˆë‹¤.")
            exit(0)

        safe_text = sanitize(raw_text)
        tts_and_play(raw_text, safe_text)
        record_and_upload(safe_text)

        print("âœ… ëª¨ë“  ì‘ì—… ì™„ë£Œ.")
    except KeyboardInterrupt:
        print("\ní”„ë¡œê·¸ë¨ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.")
