import os
import time
import re
import wave
import librosa
import numpy as np
import tensorflow as tf
import openai
import pyaudio
from io import BytesIO
from gtts import gTTS
from playsound import playsound
from google.cloud import storage
from sklearn.preprocessing import LabelEncoder
import requests  # Flask ì„œë²„ë¡œ ë°ì´í„° ì „ì†¡ì„ ìœ„í•œ requests ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€
from flask import Flask, request, jsonify

# Flask ì„œë²„ ì„¤ì •
app = Flask(__name__)

# í™˜ê²½ì„¤ì •
openai.api_key = 'YOUR_GPT_API_KEY'
os.environ["GOOGLE_APPLICATION_CREDENTIALS"] = "/home/pi/your-google-credentials.json"
bucket_name = "a_sample"

# ì´ˆê¸°í™”
RATE = 16000
CHANNELS = 1
CHUNK = 1024
FORMAT = pyaudio.paInt16
RECORD_SECONDS = 5
WAIT_SECONDS = 4  # ì•µë¬´ìƒˆê°€ ë”°ë¼ ë§í•  ì‹œê°„
audio_path = "recorded_parrot.wav"
tts_path = "tts_output.mp3"

# GCS í´ë¼ì´ì–¸íŠ¸
storage_client = storage.Client()
bucket = storage_client.bucket(bucket_name)

# CNN ëª¨ë¸ & ë¼ë²¨ ë¡œë”©
model = tf.keras.models.load_model("parrot_speech_model.h5")
label_encoder = LabelEncoder()
label_encoder.classes_ = np.load("label_classes.npy")  # ë¯¸ë¦¬ ì €ì¥ëœ í´ë˜ìŠ¤

# ìŒì„± íŠ¹ì§• ì¶”ì¶œ
def extract_features(audio_file, target_length=130):
    y, sr = librosa.load(audio_file, sr=None)
    mel_spec = librosa.feature.melspectrogram(y=y, sr=sr, n_mels=128)
    mel_spec = librosa.util.fix_length(mel_spec, size=target_length, axis=1)
    mel_spec_db = librosa.power_to_db(mel_spec, ref=np.max)
    return mel_spec_db[..., np.newaxis][np.newaxis, ...]

# GPT í”¼ë“œë°± ìƒì„±
def get_feedback(word, accuracy):
    percent = int(accuracy * 100)
    prompt = (
        f"ì•µë¬´ìƒˆê°€ '{word}'ë¼ëŠ” ë‹¨ì–´ë¥¼ ë°œìŒí–ˆìŠµë‹ˆë‹¤. "
        f"AI ëª¨ë¸ì´ íŒë‹¨í•œ ì •í™•ë„ëŠ” {percent}%ì…ë‹ˆë‹¤. "
        "ì´ ë°œìŒì— ëŒ€í•œ ì§§ê³  ì¹œê·¼í•œ í”¼ë“œë°± ë¬¸ì¥ì„ ìƒì„±í•´ì£¼ì„¸ìš”. ì˜ˆ: 'ì•„ì£¼ ì˜í–ˆì–´ìš”!', 'ì¡°ê¸ˆë§Œ ë” í˜ë‚´ìš”!'"
    )

    response = openai.ChatCompletion.create(
        model="gpt-4",
        messages=[{"role": "system", "content": "ì¹œì ˆí•œ í”¼ë“œë°±ì„ ì£¼ëŠ” ì¡°êµ"},
                  {"role": "user", "content": prompt}],
        max_tokens=60,
        temperature=0.7,
    )
    return response['choices'][0]['message']['content'].strip()

# Flask ì„œë²„ë¡œ ë°ì´í„° ì „ì†¡
def send_to_flask_server(predicted_word, confidence, feedback):
    flask_url = 'http://127.0.0.1:5000/receive_data'  # Flask ì„œë²„ URL
    data = {
        'predicted_word': predicted_word,
        'accuracy': confidence,
        'feedback': feedback
    }

    try:
        # Flask ì„œë²„ë¡œ POST ìš”ì²­ ì „ì†¡
        response = requests.post(flask_url, json=data)
        if response.status_code == 200:
            print("âœ… Flask ì„œë²„ë¡œ ë°ì´í„° ì „ì†¡ ì„±ê³µ")
        else:
            print(f"âŒ Flask ì„œë²„ ì „ì†¡ ì‹¤íŒ¨, ìƒíƒœ ì½”ë“œ: {response.status_code}")
    except Exception as e:
        print(f"âŒ Flask ì„œë²„ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")

# Flask ì„œë²„ì˜ /receive_data ì—”ë“œí¬ì¸íŠ¸
@app.route('/receive_data', methods=['POST'])
def receive_data():
    data = request.get_json()  # JSON ë°ì´í„° ë°›ê¸°
    predicted_word = data.get('predicted_word')
    accuracy = data.get('accuracy')
    feedback = data.get('feedback')

    # ë°›ì€ ë°ì´í„° ì²˜ë¦¬
    print(f"Predicted Word: {predicted_word}")
    print(f"Accuracy: {accuracy}")
    print(f"Feedback: {feedback}")

    return jsonify({"message": "Data received successfully!"}), 200

# ì•µë¬´ìƒˆ ë°œìŒ ì˜ˆì¸¡ ë° í”¼ë“œë°± ì²˜ë¦¬
def process_parrot_speech(input_text="ì•ˆë…•"):
    # TTS ë³€í™˜ ë° ì¬ìƒ
    tts = gTTS(text=input_text, lang='ko')
    tts.save(tts_path)
    playsound(tts_path)

    # ì•µë¬´ìƒˆ ëŒ€ê¸° ì‹œê°„
    print(f"â³ ì•µë¬´ìƒˆê°€ ë”°ë¼ ë§í•  ì‹œê°„ ëŒ€ê¸° ì¤‘... ({WAIT_SECONDS}ì´ˆ)")
    time.sleep(WAIT_SECONDS)

    # ë§ˆì´í¬ ë…¹ìŒ ì‹œì‘
    p = pyaudio.PyAudio()
    stream = p.open(format=FORMAT, channels=CHANNELS, rate=RATE, input=True, frames_per_buffer=CHUNK)
    print("ğŸ™ï¸ ì•µë¬´ìƒˆ ë°œì„± ë…¹ìŒ ì¤‘...")
    frames = [stream.read(CHUNK) for _ in range(0, int(RATE / CHUNK * RECORD_SECONDS))]
    print("âœ… ë…¹ìŒ ì™„ë£Œ")
    stream.stop_stream()
    stream.close()
    p.terminate()

    # WAV ì €ì¥
    with wave.open(audio_path, 'wb') as wf:
        wf.setnchannels(CHANNELS)
        wf.setsampwidth(p.get_sample_size(FORMAT))
        wf.setframerate(RATE)
        wf.writeframes(b''.join(frames))

    # ìŒì„± íŠ¹ì§• ì¶”ì¶œ
    features = extract_features(audio_path)

    # ì˜ˆì¸¡ ë° ì •í™•ë„
    prediction = model.predict(features)
    predicted_index = np.argmax(prediction)
    predicted_word = label_encoder.inverse_transform([predicted_index])[0]
    confidence = float(np.max(prediction))

    # GPT í”¼ë“œë°±
    feedback = get_feedback(predicted_word, confidence)

    # ë°ì´í„° ì„œë²„ë¡œ ì „ì†¡
    send_to_flask_server(predicted_word, confidence, feedback)

# Flask ì„œë²„ ì‹¤í–‰
if __name__ == '__main__':
    process_parrot_speech()  # ì•µë¬´ìƒˆ ë°œìŒ ì²˜ë¦¬
    app.run(debug=True)  # Flask ì„œë²„ ì‹¤í–‰
